# Azure DevOps Pipeline - TP 06 Pruebas Unitarias
# ================================================

# Este pipeline se ejecuta automÃ¡ticamente en cada push
# Ejecuta todos los tests (223 tests) y despliega si pasan

trigger:
  - main
  - develop

variables:
  buildConfiguration: "Release"
  nodeVersion: "18.x"
  goVersion: "1.21"

pool:
  vmImage: "ubuntu-latest"

steps:
  # Paso 1: Checkout del cÃ³digo
  - checkout: self
    displayName: "ğŸ“¥ Checkout Code"

  # Paso 2: Configurar Node.js
  - task: NodeTool@0
    displayName: "ğŸ”§ Setup Node.js"
    inputs:
      versionSpec: $(nodeVersion)

  # Paso 3: Configurar Go
  - task: GoTool@0
    displayName: "ğŸ”§ Setup Go"
    inputs:
      version: $(goVersion)

  # Paso 4: Instalar dependencias
  - script: |
      echo "ğŸ“¦ Instalando dependencias..."
      make install
    displayName: "ğŸ“¦ Install Dependencies"

  # Paso 5: Ejecutar linters
  - script: |
      echo "ğŸ” Ejecutando linters..."
      make lint
    displayName: "ğŸ” Run Linters"

  # Paso 6: Ejecutar TODOS los tests (223 tests)
  - script: |
      echo "ğŸ§ª Ejecutando todos los tests..."
      echo "Backend: 92 tests"
      echo "Frontend: 94 tests" 
      echo "Create Course: 37 tests"
      echo "Total: 223 tests"
      make test
    displayName: "ğŸ§ª Run All Tests (223 tests)"
    continueOnError: false

  # Paso 7: Generar reporte de cobertura
  - script: |
      echo "ğŸ“Š Generando reporte de cobertura..."
      make test-coverage
    displayName: "ğŸ“Š Generate Coverage Report"

  # Paso 8: Build de la aplicaciÃ³n
  - script: |
      echo "ğŸ—ï¸ Building application..."
      npm run build
    displayName: "ğŸ—ï¸ Build Application"

  # Paso 9: Build del backend
  - script: |
      echo "ğŸ—ï¸ Building backend..."
      cd EMARVE/backend
      go build -o main .
    displayName: "ğŸ—ï¸ Build Backend"

  # Paso 10: Publicar artefactos
  - task: PublishBuildArtifacts@1
    displayName: "ğŸ“¤ Publish Build Artifacts"
    inputs:
      pathToPublish: "$(System.DefaultWorkingDirectory)"
      artifactName: "drop"

  # Paso 11: NotificaciÃ³n de Ã©xito
  - script: |
      echo "âœ… Pipeline completado exitosamente!"
      echo "ğŸ‰ Todos los 223 tests pasaron"
      echo "ğŸš€ AplicaciÃ³n lista para despliegue"
    displayName: "âœ… Success Notification"
